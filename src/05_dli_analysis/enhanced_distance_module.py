
# å¢å¼ºçš„è·ç¦»æ•°æ® - åŸºäºCEPII GeoDistæƒå¨æ•°æ®åº“
# è¦†ç›– 224 ä¸ªå›½å®¶/åœ°åŒºï¼Œæ›¿ä»£åŸæœ‰çš„24ä¸ªç¡¬ç¼–ç è·ç¦»

COMPLETE_COUNTRY_DISTANCES = {
    "ABW": 3162,
    "AFG": 10848,
    "AGO": 10427,
    "AIA": 2717,
    "ALB": 7440,
    "AND": 6065,
    "ANT": 3227,
    "ARE": 11029,
    "ARG": 8543,
    "ARM": 9089,
    "ATG": 2876,
    "AUS": 16009,
    "AUT": 6799,
    "AZE": 9372,
    "BDI": 11383,
    "BEL": 5892,
    "BEN": 8417,
    "BFA": 7641,
    "BGD": 12680,
    "BGR": 7589,
    "BHR": 10644,
    "BHS": 1771,
    "BIH": 7188,
    "BLR": 7126,
    "BLZ": 2979,
    "BMU": 1248,
    "BOL": 6400,
    "BRA": 7694,
    "BRB": 3382,
    "BRN": 14868,
    "BTN": 12251,
    "BWA": 12584,
    "CAF": 9919,
    "CAN": 548,
    "CCK": 16765,
    "CHE": 6272,
    "CHL": 8271,
    "CHN": 10994,
    "CIV": 7949,
    "CMR": 9359,
    "COG": 10260,
    "COK": 11196,
    "COL": 4021,
    "COM": 13151,
    "CPV": 5641,
    "CRI": 3565,
    "CUB": 2115,
    "CXR": 16658,
    "CYM": 2489,
    "CYP": 8791,
    "CZE": 6574,
    "DEU": 6035,
    "DJI": 11349,
    "DMA": 3084,
    "DNK": 6192,
    "DOM": 2509,
    "DZA": 6472,
    "ECU": 4584,
    "EGY": 9028,
    "ERI": 10729,
    "ESH": 5698,
    "ESP": 5770,
    "EST": 6653,
    "ETH": 11221,
    "FIN": 6626,
    "FJI": 12786,
    "FLK": 10408,
    "FRA": 5838,
    "FRO": 4946,
    "FSM": 12515,
    "GAB": 9434,
    "GBR": 5570,
    "GEO": 8981,
    "GHA": 8246,
    "GIB": 5852,
    "GIN": 6673,
    "GLP": 2998,
    "GMB": 6307,
    "GNB": 6505,
    "GNQ": 9138,
    "GRC": 7929,
    "GRD": 3410,
    "GRL": 2978,
    "GTM": 3318,
    "GUF": 4535,
    "GUY": 4097,
    "HKG": 12970,
    "HND": 3234,
    "HRV": 6909,
    "HTI": 2476,
    "HUN": 7012,
    "IDN": 16180,
    "IND": 11762,
    "IRL": 5118,
    "IRN": 9865,
    "IRQ": 9651,
    "ISL": 4202,
    "ISR": 9120,
    "ITA": 6895,
    "JAM": 2550,
    "JOR": 9209,
    "JPN": 10856,
    "KAZ": 10241,
    "KEN": 11853,
    "KGZ": 10204,
    "KHM": 14208,
    "KIR": 11816,
    "KNA": 2827,
    "KOR": 11066,
    "KWT": 10210,
    "LAO": 13488,
    "LBN": 9032,
    "LBR": 7315,
    "LBY": 7497,
    "LCA": 3233,
    "LKA": 14093,
    "LSO": 13001,
    "LTU": 6956,
    "LUX": 6063,
    "LVA": 6759,
    "MAC": 12976,
    "MAR": 5840,
    "MDA": 7650,
    "MDG": 14007,
    "MDV": 14038,
    "MEX": 3369,
    "MHL": 11523,
    "MKD": 7509,
    "MLI": 7086,
    "MLT": 7403,
    "MMR": 13550,
    "MNG": 10167,
    "MNP": 12578,
    "MOZ": 13211,
    "MRT": 6036,
    "MSR": 2907,
    "MTQ": 3168,
    "MUS": 14928,
    "MWI": 12520,
    "MYS": 15130,
    "NAM": 11720,
    "NCL": 14066,
    "NER": 7873,
    "NFK": 14349,
    "NGA": 8493,
    "NIC": 3408,
    "NIU": 11870,
    "NLD": 5866,
    "NOR": 5917,
    "NPL": 12122,
    "NRU": 12463,
    "NZL": 14546,
    "OMN": 11357,
    "PAK": 11092,
    "PAL": 9140,
    "PAN": 3581,
    "PCN": 9338,
    "PER": 5891,
    "PHL": 13681,
    "PLW": 13940,
    "PNG": 14704,
    "POL": 6855,
    "PRI": 2594,
    "PRK": 10933,
    "PRT": 5425,
    "PRY": 7538,
    "PYF": 10123,
    "QAT": 10783,
    "REU": 14807,
    "ROM": 7656,
    "RUS": 7518,
    "RWA": 11340,
    "SAU": 10527,
    "SDN": 10225,
    "SEN": 6157,
    "SGP": 15350,
    "SHN": 9440,
    "SLB": 13709,
    "SLE": 6947,
    "SLV": 3356,
    "SMR": 6777,
    "SOM": 12283,
    "SPM": 1574,
    "STP": 9221,
    "SUR": 4309,
    "SVK": 6853,
    "SVN": 6796,
    "SWE": 6323,
    "SWZ": 13114,
    "SYC": 13599,
    "SYR": 9115,
    "TCA": 2163,
    "TCD": 9052,
    "TGO": 8336,
    "THA": 13943,
    "TJK": 10426,
    "TKL": 11342,
    "TKM": 10025,
    "TMP": 15963,
    "TON": 12456,
    "TTO": 3569,
    "TUN": 7023,
    "TUR": 8071,
    "TUV": 12047,
    "TWN": 12533,
    "TZA": 12471,
    "UGA": 11382,
    "UKR": 7516,
    "URY": 8617,
    "USA": 1161,
    "UZB": 10180,
    "VCT": 3309,
    "VEN": 3429,
    "VGB": 2639,
    "VNM": 13159,
    "VUT": 13612,
    "WLF": 12000,
    "WSM": 13050,
    "YEM": 11120,
    "YUG": 7266,
    "ZAF": 12582,
    "ZAR": 10270,
    "ZMB": 12156,
    "ZWE": 12552
}

def get_enhanced_distance(country_code: str, energy_product: str = None) -> float:
    """
    è·å–å¢å¼ºçš„å›½å®¶è·ç¦»æ•°æ®
    
    Args:
        country_code: ISO 3166-1 alpha-3 å›½å®¶ä»£ç 
        energy_product: èƒ½æºäº§å“ç±»å‹ï¼ˆå¯ç”¨äºæœªæ¥çš„äº§å“ç‰¹å¼‚æ€§è·ç¦»ï¼‰
        
    Returns:
        è·ç¦»ï¼ˆå…¬é‡Œï¼‰
    """
    # ä½¿ç”¨CEPIIæƒå¨æ•°æ®
    distance = COMPLETE_COUNTRY_DISTANCES.get(country_code)
    
    if distance is not None:
        return distance
    
    # å¦‚æœä»ç„¶æ²¡æœ‰æ‰¾åˆ°ï¼Œä½¿ç”¨åŒºåŸŸå¹³å‡å€¼
    # è¿™æ¯”å…¨çƒå¹³å‡å€¼æ›´ç²¾ç¡®
    regional_averages = {
        # åŸºäºUNåœ°ç†åŒºåŸŸçš„å¹³å‡è·ç¦»
        'africa': 10500,
        'asia': 11500, 
        'europe': 7000,
        'oceania': 16000,
        'south_america': 7500,
        'north_america': 3500
    }
    
    # ç®€å•çš„åŒºåŸŸæ˜ å°„ï¼ˆå¯ä»¥è¿›ä¸€æ­¥å®Œå–„ï¼‰
    country_regions = {
        # éæ´²å›½å®¶æ ·ä¾‹
        'ETH': 'africa', 'KEN': 'africa', 'TZA': 'africa',
        # äºšæ´²å›½å®¶æ ·ä¾‹  
        'THA': 'asia', 'VNM': 'asia', 'MYS': 'asia',
        # æ¬§æ´²å›½å®¶æ ·ä¾‹
        'SVK': 'europe', 'SVN': 'europe', 'EST': 'europe',
        # å¤§æ´‹æ´²
        'FJI': 'oceania', 'PNG': 'oceania',
        # å—ç¾æ´²
        'URY': 'south_america', 'PRY': 'south_america',
        # åŒ—ç¾æ´²/åŠ å‹’æ¯”
        'GTM': 'north_america', 'HND': 'north_america'
    }
    
    region = country_regions.get(country_code, 'asia')  # é»˜è®¤äºšæ´²
    return regional_averages[region]

def add_enhanced_distance_data(trade_df: pd.DataFrame) -> pd.DataFrame:
    """
    ä¸ºè´¸æ˜“æ•°æ®æ·»åŠ å¢å¼ºçš„è·ç¦»ä¿¡æ¯
    
    ä½¿ç”¨CEPIIæƒå¨æ•°æ®åº“çš„å®Œæ•´è·ç¦»æ•°æ®ï¼Œè¦†ç›–224ä¸ªå›½å®¶
    """
    df = trade_df.copy()
    
    # ä½¿ç”¨å¢å¼ºçš„è·ç¦»è®¡ç®—
    df['distance_km'] = df['us_partner'].apply(
        lambda x: get_enhanced_distance(x, df.loc[df['us_partner']==x, 'energy_product'].iloc[0] if len(df[df['us_partner']==x]) > 0 else None)
    )
    
    # ç»Ÿè®¡è¦†ç›–æƒ…å†µ
    cepii_covered = df['us_partner'].isin(COMPLETE_COUNTRY_DISTANCES.keys()).sum()
    total_countries = df['us_partner'].nunique()
    
    logger.info(f"ğŸŒ è·ç¦»æ•°æ®è¦†ç›–: {cepii_covered}/{total_countries} å›½å®¶ä½¿ç”¨CEPIIæƒå¨æ•°æ®")
    logger.info(f"ğŸ“Š æ•°æ®è¦†ç›–ç‡: {cepii_covered/total_countries*100:.1f}%")
    
    return df
