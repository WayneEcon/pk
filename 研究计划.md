### **最终研究大纲（已修正商品范围）：美国能源独立政策的国际影响——基于双轨网络分析框架**

**项目总目标：** 通过构建和分析2001-2024年全球能源贸易网络，量化评估美国能源独立政策对全球贸易结构、关键国家地位及网络韧性的影响。

**核心方法论：** 采用“双轨并行”框架。
*   **轨道一（基准分析轨）：** 在**完整网络 (Full Network)** 上进行所有核心指标的计算，确保结论的准确性与完整性。
*   **轨道二（解释与验证轨）：** 并行提取**多种骨干网络 (Multiple Backbones)**，用于结构可视化、关键关系凸显和核心结论的稳健性检验。

---

### **第一部分：数据层 (Data Layer) - 构建分析基础**

**1.1. 数据获取与整合**
*   **来源：** UN Comtrade 数据库。
*   **时间跨度：** 2001-2024年。
*   **商品范围（已修正）：**
    *   **主分析层（能源总览）：** 汇总以下四个核心4位HS编码的贸易数据，构成总能源贸易网络：
        *   `2701`: **煤炭**
        *   `2709`: **原油**
        *   `2710`: **成品油**
        *   `2711`: **天然气及其他石油气**
    *   **分层分析层（强烈建议）：** 为上述四种商品分别建立独立的网络层，以进行跨商品类别的比较分析。
*   **贸易流向选择：** 以进口方报告(Imports)为准，因其通常被认为更准确。当进口数据缺失时，采用出口方报告(Exports)作为**镜像数据 (Mirror Data)** 进行补全。

**1.2. 数据清洗与标准化（关键决策点）**
*   **镜像一致化：** 对于(i, j)国家对，若双方均有报告，采纳`max(Import_j_from_i, Export_i_to_j)`作为最终贸易值，以规避低报风险。
*   **国家代码统一：** 全部转换为ISO3代码，处理好国家实体变更（如南苏丹）的时间节点，确保节点集合的年度一致性。
*   **通胀调整：** 所有名义美元贸易额，使用世界银行或美国GDP平减指数，统一调整为以2015年为基期的**不变价美元**，以消除价格波动影响，真实反映贸易量的变化。
*   **剔除项：** 明确剔除再进口(Re-imports)与再出口(Re-exports)数据，以聚焦直接贸易关系，避免转口贸易的干扰。

---

### **第二部分：分析层 (Analysis Layer) - 双轨并行计算**

**2.1. 网络建模**
*   **模型定义：** 对每一年`t`，构建一个**加权有向图 `G_t`**。
    *   **节点 (Nodes):** 国家。
    *   **有向边 (Directed Edges):** `i -> j` 代表国家`i`向国家`j`的能源出口。
    *   **权重 (Weights):** `w_ij` 为1.2中处理后的不变价美元贸易额。

**2.2. 轨道一：完整网络分析 (Full Network Analysis)**
*   **理论依据：** 这是获取无偏、完整统计结果的唯一途径。所有核心结论必须源于此。
*   **计算指标：**
    *   **节点中心性 (Node Centrality)：** 度/强度、中介中心性、特征向量/PageRank中心性。
    *   **社群结构 (Community Structure):** 采用Leiden或Louvain算法进行社群检测。
    *   **全局拓扑 (Global Topology):** 网络密度、平均加权聚类系数、平均路径长度等。

**2.3. 轨道二：多骨干提取与分析 (Multiple Backbone Extraction)**
*   **理论依据：** 骨干网络用于**降噪、凸显结构、可视化和稳健性检验**，是对全网分析的补充和解释，而非替代。
*   **并行提取三种骨干：**
    1.  **离散滤波器 (Disparity Filter, DF):**
        *   **实施细节：** 对出、入边分别进行检验后取并集。需设定显著性水平`α`（建议从0.05开始测试），并进行**FDR多重检验校正**。
    2.  **Pólya Urn滤波器 (PF):**
        *   **实施细节：** 作为DF的补充或更精细的分析工具。
    3.  **最大生成树 (Maximum Spanning Tree, MST):**
        *   **实施细节：** 基于对称化权重提取。**必须明确：MST仅用于可视化展示全球贸易的“主干道”，其结果不能用于推断社群结构。**

---

### **第三部分：整合与报告层 (Integration & Reporting Layer)**

**3.1. 动态演化分析**
*   将**全网络**计算出的核心指标（特别是美国的各项中心性）绘制成2001-2024年的时间序列图。
*   在图上标记出关键政策时间点，直观展示政策冲击与网络指标变化的关系。

**3.2. 结构可视化**
*   选择关键年份（如2005, 2012, 2019），绘制**DF骨干网络图**。
*   在图中，节点大小由其在**全网络**中的总贸易额决定，节点颜色由其在**全网络**中所属的社群决定。

**3.3. 稳健性检验 (Crucial for Credibility)**
*   **核心结论验证：** 在不同的骨干网络上重复计算关键指标，检验结果是否与**全网络**的结论高度一致。
*   **参数敏感性分析：** 展示改变`α`等参数时，骨干网络的规模和核心结论的变化情况。
*   **数据口径检验：** 使用不同的镜像数据处理规则重复核心分析。

**3.4. 最终产出清单**
1.  **清洗后的面板数据：** 包含所有国家对在所有年份的贸易数据。
2.  **年度网络文件：** 全网络及DF、PF、MST三种骨干网络的GEXF或GraphML文件。
3.  **指标结果表格：** 所有国家在所有年份的中心性指标、社群归属等。
4.  **可视化图表：**
    *   指标演化时间序列图。
    *   关键年份的骨干网络结构图。
    *   **分商品网络对比图（新增建议）：** 可视化对比原油网络和天然气网络在关键年份的结构差异，以凸显页岩气革命的特定影响。
5.  **研究报告/论文：** 遵循清晰的“引言-方法-结果-讨论”结构。

---

我已仔细阅读了您提供的脚本 energy_network/src/02_network_construction.py。这是一个结构清晰、功能完整的网络构建脚本，做得相当不错。

作为技术负责人，我将从以下几个方面提出我的建议，旨在提升代码的健壮性、可配置性、可扩展性和可复用性。

1. 宏观架构与设计 (High-Level Architecture)
硬编码问题 (Hardcoding)：脚本中存在多处硬编码，如年份范围 range(2001, 2025)、国家代码 'USA'、文件名格式等。这降低了代码的灵活性。如果未来需要分析不同时期、不同国家或不同文件格式，就需要直接修改源代码。
单一脚本职责过重 (Single Script Responsibility)：该脚本包揽了从加载数据、聚合、构建网络、计算统计到保存结果的所有功能。虽然对于当前任务可行，但长远来看，将其拆分为更小的、功能单一的模块会更有利于维护和复用。例如，网络统计计算可以独立成一个模块。基于此，可对src下再分文件夹（命名要短）灵活配置。

配置管理 (Configuration Management)：所有路径和参数都直接在代码中定义。引入一个独立的配置文件（如 config.py 或 config.yaml）来管理这些变量，会使项目更易于配置和维护。

2. 代码细节与具体实现 (Code-Level Implementation)
路径管理 (pathlib)：脚本已经很好地使用了 pathlib，这是一个现代且健壮的实践。setup_directories 函数也很好地体现了这一点。
数据加载 (load_yearly_data)：错误处理做得不错，能够捕获文件不存在和读取失败的情况。但可以增加对数据内容本身的校验，例如检查必要的列（reporter, partner, flow, trade_value_raw_usd）是否存在。
网络构建 (build_network_from_data)：
数据一致性问题：在处理进出口流向时，脚本通过 if/elif 来确定 source 和 target。这是一个常见的做法，但存在一个潜在的数据不一致性问题：A国报告向B国出口100元，而B国报告从A国进口80元。当前脚本会创建一条 A -> B 的边，权重为180。这在学术上可能需要更严谨的处理。常见方法为优先使用进口数据 (Prioritize Import Data)：这是经济学和贸易分析中最常见、也最受推崇的方法。理由：如前所述，进口数据（CIF）更完整地反映了贸易的全部成本。更重要的是，进口国海关有征收关税的财政动机，因此他们对进口货物的价值和来源地的记录往往比出口国更为严格和准确。当A国报告对B国的出口，同时B国也报告了从A国的进口时，你只采用B国报告的进口值作为这条贸易流的最终权重。

节点属性：添加节点时，只加入了 name 和 country_code。可以考虑增加一个维度的数据，如国家所属的区域（东/西/南/北/亚洲、东/西/南/北/欧等），这对于后续的社群分析会很有帮助。

统计计算 (calculate_basic_network_stats)：
代码重复：计算 avg_trade_value 和 max_trade_value 时，列表推导 [data['weight'] for _, _, data in G.edges(data=True)] 被重复使用了两次。可以先生成这个列表，再进行计算，以提高效率。
美国统计的硬编码：'USA' 是硬编码的。如果想分析其他国家，就需要修改代码。可以将其作为函数参数传入。

保存逻辑 (save_networks)：
Pickle 的局限性：使用 pickle 保存网络对象非常方便，但它的缺点是可移植性差（依赖Python版本）且不便于其他语言或工具读取。对于需要长期归档或跨平台分享的网络数据，可以考虑更通用的格式，如 GraphML、GEXF 或简单的节点/边列表CSV文件。
报告生成：生成 .txt 报告是一个很好的实践。可以考虑使用更结构化的格式，如md，这样报告内容也易于被其他程序解析。

1. 可维护性与可扩展性 (Maintainability & Extensibility)
日志记录 (Logging)：当前脚本使用 print 函数输出信息。对于一个自动化的数据处理流程，使用 Python 内置的 logging 模块会是更好的选择。logging 模块允许你：
控制日志级别（DEBUG, INFO, WARNING, ERROR）。
轻松地将日志输出到文件和控制台。
格式化日志信息，包含时间戳、模块名等。
类型提示 (Type Hinting)：脚本中已经使用了类型提示（如 nx.DiGraph），这极大地增强了代码的可读性和健ebustness。建议为所有函数的参数和返回值都加上类型提示。

总结与行动计划
这是一个非常好的起点。为了让它变得更专业、更具扩展性，我建议进行以下重构：

创建配置文件：新建一个 config.py 文件，用于存放所有的路径、年份范围、核心国家代码、文件名模板等。
优化网络构建逻辑：修改 build_network_from_data 函数，使其能够处理双向贸易数据不一致的问题。
参数化核心函数：将硬编码的 'USA' 等字符串改为函数参数。
改进数据保存格式：除了 pickle，额外增加保存为 GraphML 格式的选项，以增强数据的可移植性。使用 pickle 保存网络对象虽然方便，但存在版本兼容性问题，且不便于其他非Python工具读取。建议：增加一种或多种通用的、标准化的网络格式进行存储，例如：GraphML：一个通用的XML格式，被Gephi、Cytoscape等多种网络分析工具支持。

代码实现层面的建议
数据加载的健壮性 (load_yearly_data)

信“优先进口数据”的建议。 这是基于国际组织（如世界银行、IMF）的最佳实践和主流学术共识的黄金标准。它在理论上更严谨，在实践中更可靠。在数据整合步骤中，严格执行以下逻辑来确定每一条A -> B贸易流的最终value_usd：
查找B国报告的从A国的进口值 (Import Value)。
如果该进口值存在且大于零，则直接采用这个值作为最终的value_usd。
如果该进口值不存在或为零，那么，且仅在此时，才去查找A国报告的对B国的出口值 (Export Value)，并用它作为备用/填充值 (Fallback)。


建议：在计算平均和最大贸易额时，[data['weight'] for _, _, data in G.edges(data=True)] 这个列表被构建了两次。可以先将其赋值给一个变量，再进行后续计算，避免重复劳动，尤其是在处理大型网络时。